<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profil - Seminar KP</title>
    <link rel="stylesheet" href="css/style.css">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
    <style>
        /* Global Black Body */
        body {
            background-color: #000000;
            margin: 0;
            font-family: 'Outfit', sans-serif;
            display: flex;
            justify-content: center;
        }

        .app-container {
            background: white !important;
            padding-bottom: 90px;
            width: 100%;
            max-width: 480px;
            min-height: 100vh;
            position: relative;
        }

        .profile-header {
            background: #001E6C;
            padding: 40px 20px 80px;
            /* More bottom padding for curve */
            color: white;
            text-align: center;
            border-radius: 0 0 50% 50% / 0 0 40px 40px;
            /* Curved bottom */
            position: relative;
            overflow: hidden;
            margin-bottom: 20px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }

        /* Glow effect */
        .profile-header::after {
            content: '';
            position: absolute;
            bottom: -50px;
            left: 50%;
            transform: translateX(-50%);
            width: 80%;
            height: 100px;
            background: radial-gradient(circle, rgba(66, 133, 244, 0.8) 0%, rgba(0, 30, 108, 0) 70%);
            filter: blur(20px);
            z-index: 0;
        }

        /* Ensure content is above glow */
        .profile-header>* {
            position: relative;
            z-index: 1;
        }

        .avatar-container {
            width: 80px;
            height: 80px;
            background: white;
            border-radius: 50%;
            padding: 4px;
            margin: 0 auto 12px;
            position: relative;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }

        .avatar-img {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
        }

        .edit-avatar-btn {
            position: absolute;
            bottom: 0;
            right: 0;
            background: #F59E0B;
            /* Gold accent */
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid white;
        }

        .profile-name {
            font-size: 20px;
            margin-bottom: 4px;
            font-weight: 700;
        }

        .profile-email {
            font-size: 14px;
            opacity: 0.8;
            font-weight: 300;
        }

        .profile-card {
            background: white;
            border-radius: 16px;
            padding: 8px 0;
            margin: 0 20px 20px;
            /* Reset margins */
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
            /* Softer shadow */
            border: 1px solid #f0f0f0;
            position: relative;
        }

        .menu-item {
            display: flex;
            align-items: center;
            padding: 16px 20px;
            text-decoration: none;
            color: var(--text-main);
            transition: background 0.2s;
        }

        .menu-item:active {
            background: #F3F4F6;
        }

        .menu-icon {
            color: var(--text-muted);
            margin-right: 16px;
        }

        .menu-text {
            flex: 1;
            font-size: 15px;
            font-weight: 500;
        }

        .menu-arrow {
            color: var(--text-muted);
            font-size: 16px;
        }

        .logout-btn {
            margin: 30px auto;
            background: #ff0000;
            color: white;
            border: none;
            width: auto;
            min-width: 160px;
            max-width: 200px;
            border-radius: 50px;
            box-shadow: 0 4px 15px rgba(255, 0, 0, 0.2);
            display: flex;
            justify-content: center;
        }

        /* Notification Styles */
        .notif-badge {
            background: #EF4444;
            color: white;
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 10px;
            margin-left: 8px;
        }

        .notif-item {
            padding: 12px 20px;
            border-bottom: 1px solid #f0f0f0;
            display: flex;
            gap: 12px;
            align-items: flex-start;
        }

        .notif-item:last-child {
            border-bottom: none;
        }

        .notif-icon {
            color: #2563EB;
            font-size: 20px;
            margin-top: 2px;
        }

        .notif-text {
            font-size: 13px;
            line-height: 1.4;
            color: #374151;
        }

        .notif-time {
            font-size: 10px;
            color: #9CA3AF;
            margin-top: 4px;
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            padding: 0 20px;
            margin-bottom: 24px;
        }

        .stat-card {
            background: white;
            border-radius: 12px;
            padding: 15px 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            border: 1px solid #f0f0f0;
        }

        .stat-icon {
            width: 36px;
            height: 36px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 8px;
        }

        .stat-icon.blue {
            background: #EFF6FF;
            color: #3B82F6;
        }

        .stat-icon.orange {
            background: #FFF7ED;
            color: #F97316;
        }

        .stat-icon.green {
            background: #F0FDF4;
            color: #22C55E;
        }

        .stat-value {
            font-size: 20px;
            font-weight: 800;
            color: #1e293b;
            line-height: 1;
            margin-bottom: 4px;
        }

        .stat-label {
            font-size: 10px;
            color: #64748b;
            font-weight: 500;
        }

        /* History List */
        .history-list {
            padding: 0 20px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-bottom: 24px;
        }

        .history-item {
            background: white;
            padding: 16px;
            border-radius: 16px;
            display: flex;
            align-items: center;
            gap: 16px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.03);
            border: 1px solid #f0f0f0;
        }

        .history-icon-box {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            background: #F1F5F9;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #64748b;
            flex-shrink: 0;
        }

        .history-content {
            flex: 1;
            min-width: 0;
            /* Fix flex truncation issue */
            margin-right: 8px;
            /* Add spacing to badge */
        }

        .history-title {
            font-size: 14px;
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 2px;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            white-space: normal;
            line-height: 1.3;
        }

        .history-date {
            font-size: 11px;
            color: #94a3b8;
        }

        .status-badge {
            font-size: 10px;
            font-weight: 700;
            padding: 4px 8px;
            border-radius: 6px;
        }

        .status-badge.success {
            background: #DCFCE7;
            color: #166534;
        }

        .status-badge.pending {
            background: #FEF3C7;
            color: #D97706;
        }

        .status-badge.error {
            background: #FEE2E2;
            color: #B91C1C;
        }

        .btn-upload-list {
            background: #001E6C;
            color: white;
            border: none;
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 10px;
            cursor: pointer;
            font-weight: 600;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
        }

        .modal-content {
            background-color: white;
            margin: 30% auto;
            padding: 30px;
            border-radius: 24px;
            width: 90%;
            max-width: 420px;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(0, 0, 0, 0.05);
            animation: modalPop 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        @keyframes modalPop {
            from {
                opacity: 0;
                transform: scale(0.9) translateY(20px);
            }

            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        .modal-label {
            display: block;
            font-size: 13px;
            color: #1e293b;
            font-weight: 800;
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 0.8px;
        }

        .file-input-container {
            position: relative;
            background: #F8FAFC;
            border: 2px dashed #CBD5E1;
            border-radius: 16px;
            padding: 24px;
            text-align: center;
            transition: all 0.2s;
            cursor: pointer;
        }

        .file-input-container:hover {
            border-color: #001E6C;
            background: #EFF6FF;
        }

        .file-input-container input[type="file"] {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
            cursor: pointer;
        }

        .file-msg {
            font-size: 14px;
            color: #64748b;
            font-weight: 500;
        }

        .file-icon {
            font-size: 32px;
            color: #94a3b8;
            margin-bottom: 8px;
            display: block;
        }
    </style>
</head>

<body>
    <div class="app-container">
        <div class="profile-header">
            <div class="avatar-container">
                <img src="https://via.placeholder.com/80" alt="Avatar" class="avatar-img">
                <div class="edit-avatar-btn">
                    <span class="material-icons-round" style="font-size: 14px; color: white;">edit</span>
                </div>
            </div>
            <h2 class="profile-name" id="profileName">Memuat...</h2>
            <p class="profile-email" id="profileEmail">Memuat...</p>
        </div>

        <!-- Stats Grid -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon green">
                    <span class="material-icons-round" style="font-size: 20px;">task_alt</span>
                </div>
                <div class="stat-value" id="countAttended">0</div>
                <div class="stat-label">Seminar Diikuti</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon blue">
                    <span class="material-icons-round" style="font-size: 20px;">event_repeat</span>
                </div>
                <div class="stat-value" id="countRegistered">0</div>
                <div class="stat-label">Seminar Terdaftar</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon orange">
                    <span class="material-icons-round" style="font-size: 20px;">co_present</span>
                </div>
                <div class="stat-value" id="countProposed">0</div>
                <div class="stat-label">Seminar Diajukan</div>
            </div>
        </div>

        <!-- History List Embed -->
        <h3 style="margin: 0 20px 10px; font-size: 16px; color: #1F2937;">Aktivitas Terbaru</h3>
        <div class="history-list" id="historyContainer">
            <div style="text-align:center; padding:20px; color:#64748b; font-size:12px;">Memuat data...</div>
        </div>

        <h3 style="margin: 0 20px 10px; font-size: 16px; color: #1F2937;">Notifikasi</h3>
        <div class="profile-card" id="notifContainer" style="max-height: 300px; overflow-y: auto;">
            <div style="padding: 20px; text-align: center; color: #9CA3AF; font-size: 14px;">Memuat notifikasi...</div>
        </div>


        <button class="btn logout-btn" onclick="handleLogout()">
            <span class="material-icons-round" style="margin-right: 8px;">logout</span>
            Keluar
        </button>

        <!-- Bottom Nav Standard -->
        <nav class="nav-shape"
            style="position: fixed; bottom: 0; width: 100%; max-width: 480px; height: 70px; background: #001E6C; border-radius: 30px 30px 0 0; display: flex; justify-content: space-around; align-items: center; padding: 0 10px; z-index: 100;">
            <a href="home.html" class="nav-item"
                style="display: flex; flex-direction: column; align-items: center; text-decoration: none; color: rgba(255,255,255,0.5);">
                <span class="material-icons-round" style="font-size: 24px;">home</span>
                <span style="font-size: 10px; font-weight: 600;">Home</span>
            </a>
            <a href="explore.html" class="nav-item"
                style="display: flex; flex-direction: column; align-items: center; text-decoration: none; color: rgba(255,255,255,0.5);">
                <span class="material-icons-round" style="font-size: 24px;">calendar_today</span>
                <span style="font-size: 10px; font-weight: 600;">Jadwal</span>
            </a>
            <a href="alur.html" class="nav-item"
                style="display: flex; flex-direction: column; align-items: center; text-decoration: none; color: rgba(255,255,255,0.5);">
                <span class="material-icons-round" style="font-size: 24px;">sync_alt</span>
                <span style="font-size: 10px; font-weight: 600;">Alur</span>
            </a>
            <a href="profile.html" class="nav-item-active"
                style="display: flex; flex-direction: column; align-items: center; text-decoration: none; color: #93C5FD;">
                <span class="material-icons-round" style="font-size: 24px;">person</span>
                <span style="font-size: 10px; font-weight: 600;">Profile</span>
            </a>
        </nav>
    </div>

    <!-- Upload Modal -->
    <div id="uploadModal" class="modal">
        <div class="modal-content">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <h3 style="margin:0; font-size:18px;">Upload Bukti</h3>
                <span class="material-icons-round" style="cursor:pointer;" onclick="closeModal()">close</span>
            </div>
            <form id="uploadForm">
                <input type="hidden" name="registration_id" id="regId">
                <div style="margin-bottom:24px;">
                    <label class="modal-label">Bukti Kehadiran (JPG/PNG)</label>
                    <div class="file-input-container" id="dropZone">
                        <span class="material-icons-round file-icon">cloud_upload</span>
                        <span class="file-msg" id="fileNameDisplay">Pilih foto atau tarik ke sini</span>
                        <input type="file" name="proof" id="proofFile" accept="image/*" required
                            onchange="updateFileName(this)">
                    </div>
                </div>
                <button type="submit" id="btnSubmitUpload"
                    style="width:100%; background:#001E6C; color:white; border:none; padding:14px; border-radius:12px; font-weight:700; font-size:15px; cursor:pointer; box-shadow: 0 4px 15px rgba(0,30,108,0.2); text-transform:uppercase; letter-spacing:1px;">Kirim
                    Bukti</button>
            </form>
        </div>
    </div>

    <script src="js/main.js"></script>
    <script>
        // Load user profile data
        async function loadProfile() {
            try {
                // First try localStorage (from login) for immediate display
                const userName = localStorage.getItem('userName');
                const userEmail = localStorage.getItem('userEmail');

                if (userName) {
                    document.getElementById('profileName').textContent = userName;
                }
                if (userEmail) {
                    document.getElementById('profileEmail').textContent = userEmail;
                }

                // Then fetch full data from backend to ensure accuracy
                const response = await fetch('php/get_profile.php');
                const data = await response.json();

                if (data.status === 'success') {
                    const user = data.data;
                    document.getElementById('profileName').textContent = user.name;
                    document.getElementById('profileEmail').textContent = user.email;

                    // Update localStorage too
                    localStorage.setItem('userName', user.name);
                    localStorage.setItem('userEmail', user.email);

                    // Load Notifications
                    loadNotifications();
                    // Load History
                    loadHistory();
                } else {
                    // Not logged in, redirect to login
                    window.location.href = 'login.html';
                }
            } catch (err) {
                console.error('Error loading profile:', err);
                // Fallback to localStorage
                const userName = localStorage.getItem('userName');
                const userEmail = localStorage.getItem('userEmail');

                if (userName) {
                    document.getElementById('profileName').textContent = userName;
                    document.getElementById('profileEmail').textContent = userEmail || 'Email tidak tersedia';
                    loadNotifications();
                    loadHistory();
                } else {
                    window.location.href = 'login.html';
                }
            }
        }

        async function loadNotifications() {
            const container = document.getElementById('notifContainer');
            try {
                const res = await fetch('php/api_get_notifications.php');
                const result = await res.json();

                if (result.status === 'success' && Array.isArray(result.data) && result.data.length > 0) {
                    container.innerHTML = '';
                    result.data.forEach(n => {
                        container.innerHTML += `
                            <div class="notif-item">
                                <span class="material-icons-round notif-icon">notifications</span>
                                <div>
                                    <div class="notif-text">${(n.message || '').replace(/</g, '&lt;')}</div>
                                    <div class="notif-time">${n.created_at || ''}</div>
                                </div>
                            </div>
                        `;
                    });
                } else {
                    container.innerHTML = '<div style="padding: 20px; text-align: center; color: #9CA3AF; font-size: 14px;">Belum ada notifikasi</div>';
                }
            } catch (e) {
                console.error('Notif error:', e);
                container.innerHTML = '<div style="padding: 20px; text-align: center; color: #EF4444; font-size: 14px;">Gagal memuat notifikasi</div>';
            }
        }

        function handleLogout() {
            showConfirm('Logout?', 'Apakah Anda yakin ingin keluar?', () => {
                localStorage.clear();
                showModal('success', 'Logout Berhasil', 'Anda telah keluar dari sistem.', () => {
                    window.location.href = 'login.html';
                });
            });
        }

        function updateFileName(input) {
            const display = document.getElementById('fileNameDisplay');
            if (input.files && input.files[0]) {
                display.textContent = input.files[0].name;
                display.style.color = '#001E6C';
            } else {
                display.textContent = 'Pilih foto atau tarik ke sini';
                display.style.color = '#64748b';
            }
        }

        // History & Upload Logic
        async function loadHistory() {
            try {
                const response = await fetch('php/api_history.php');
                const data = await response.json();

                if (data.status === 'success') {
                    renderHistory(data.data);
                } else {
                    document.getElementById('historyContainer').innerHTML = '<div style="text-align:center;">Gagal memuat data.</div>';
                }
            } catch (error) {
                console.error(error);
            }
        }

        function renderHistory(items) {
            const container = document.getElementById('historyContainer');
            const attEl = document.getElementById('countAttended');
            const regEl = document.getElementById('countRegistered');
            const propEl = document.getElementById('countProposed');

            if (items.length === 0) {
                container.innerHTML = '<div style="text-align:center; padding:20px; color:#64748b; font-size:12px;">Belum ada aktivitas.</div>';
                attEl.innerText = '0'; regEl.innerText = '0'; propEl.innerText = '0';
                return;
            }

            // container.innerHTML = ''; // Keep content clean
            // Limit to top 5? The user said "langsung kelihatan", implying useful list.
            // Let's show all or maybe top 5? User didn't specify limit. I'll show all but in scrollable page.

            container.innerHTML = '';
            let attended = 0;
            let registered = 0;
            let proposed = 0;

            const today = new Date();
            today.setHours(0, 0, 0, 0);

            items.forEach(item => {
                const isProposer = (item.type === 'proposer');
                if (isProposer) {
                    proposed++;
                } else {
                    if (item.status === 'attended') attended++;
                    else registered++;
                }

                // Determine badge color
                let statusClass = 'pending';
                let statusText = 'Proses';
                let showUpload = false;

                if (isProposer) {
                    if (item.status === 'active' || item.status === 'full') {
                        statusClass = 'success'; statusText = 'Aktif';
                    } else if (item.status === 'finished') {
                        statusClass = 'success'; statusText = 'Selesai';
                    } else if (item.status === 'rejected') {
                        statusClass = 'error'; statusText = 'Ditolak';
                    }
                } else {
                    // Participant
                    if (item.status === 'attended') {
                        statusClass = 'success'; statusText = 'Selesai';
                    } else if (item.status === 'approved' || item.status === 'attendance_confirmed') {
                        statusClass = 'success'; statusText = 'Terdaftar';
                        const itemDate = new Date(item.date);
                        itemDate.setHours(0, 0, 0, 0);
                        if (itemDate <= today) {
                            showUpload = true;
                        }
                    } else if (item.status === 'rejected') {
                        statusClass = 'error'; statusText = 'Ditolak';
                    } else if (item.status === 'pending_verification') {
                        statusClass = 'pending'; statusText = 'Verifikasi';
                    }
                }

                // Format Date
                let formattedDate = item.date;
                try {
                    const dateParts = item.date.split('-');
                    const dateObj = new Date(dateParts[0], dateParts[1] - 1, dateParts[2]);
                    const options = { day: 'numeric', month: 'short', year: 'numeric' };
                    formattedDate = dateObj.toLocaleDateString('id-ID', options);
                } catch (e) { }

                const label = isProposer ? 'Penyeminar' : 'Peserta';
                const icon = isProposer ? 'record_voice_over' : 'event_available';
                const timeRange = item.time_start && item.time_end ? `${item.time_start.substring(0, 5)} - ${item.time_end.substring(0, 5)}` : '';

                const html = `
                <div class="history-item">
                    <div class="history-icon-box">
                        <span class="material-icons-round">${icon}</span>
                    </div>
                    <div class="history-content">
                        <div class="history-title">${item.title}</div>
                        <div class="history-date">${formattedDate} ${timeRange ? '• ' + timeRange : ''} • ${label}</div>
                    </div>
                    ${showUpload ?
                        `<button class="btn-upload-list" onclick="openUploadModal(${item.id})">Upload Bukti</button>` :
                        `<div class="status-badge ${statusClass}">${statusText}</div>`
                    }
                </div>
                `;
                container.innerHTML += html;
            });

            if (attEl) attEl.innerText = attended;
            if (regEl) regEl.innerText = registered;
            if (propEl) propEl.innerText = proposed;
        }

        function openUploadModal(regId) {
            document.getElementById('regId').value = regId;
            document.getElementById('uploadModal').style.display = 'block';
        }

        function closeModal() {
            document.getElementById('uploadModal').style.display = 'none';
        }

        // Handle Upload Submit
        const uploadForm = document.getElementById('uploadForm');
        if (uploadForm) {
            uploadForm.onsubmit = async (e) => {
                e.preventDefault();
                const btn = document.getElementById('btnSubmitUpload');
                btn.disabled = true;
                btn.innerText = 'Mengupload...';

                const formData = new FormData(uploadForm);

                // Progress-aware upload
                const xhr = new XMLHttpRequest();
                xhr.open('POST', 'php/api_upload_attendance.php', true);

                xhr.upload.onprogress = (e) => {
                    if (e.lengthComputable) {
                        const pct = Math.round((e.loaded / e.total) * 100);
                        btn.innerText = `Mengupload... ${pct}%`;
                    }
                };

                xhr.onload = () => {
                    try {
                        const data = JSON.parse(xhr.responseText);
                        if (data.status === 'success') {
                            showModal('success', 'Berhasil', data.message);
                            closeModal();
                            loadHistory();
                        } else {
                            showModal('error', 'Gagal', data.message);
                        }
                    } catch (err) {
                        showModal('error', 'Error', 'Gagal memproses detail: ' + err.message);
                    }
                    btn.disabled = false;
                    btn.innerText = 'Kirim Bukti';
                };

                xhr.onerror = () => {
                    showModal('error', 'Koneksi Error', 'Gagal terhubung ke server.');
                    btn.disabled = false;
                    btn.innerText = 'Kirim Bukti';
                };

                xhr.send(formData);
            };
        }

        // Load profile on page load
        window.addEventListener('DOMContentLoaded', loadProfile);
    </script>
    <script src="js/main.js"></script>
</body>

</html>